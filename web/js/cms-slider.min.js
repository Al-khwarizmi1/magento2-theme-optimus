require(["jquery"], function($){

  $.fn.funslider = function ( options ) {

    var settings = $.extend({
        width: 1240,
        height: 400,
        placeholderPath: '',
        wait: 6000,
        delay: 6000,
        autoPlay: true
    }, options );
 
    return this.each(function() {

        if($(window).width() < 769) {
            settings.autoPlay = false;
        }

        var dataElem = $( this );
        // hide the original data
        dataElem.addClass( "funSlided" );

        var clickThrough = "#";
        
        var nSlides = dataElem.find('li').length;
        var currentSlide = 0;

        // create wrapping elements
        dataElem.wrap( '<div class="funslider"></div>' );
        var desktopSlider = $('<div class="desktop-slider" />');
        dataElem.parent().append(desktopSlider);
        var mobileSlider = $('<div class="mobile-slider" />');
        var mobileSliderWrapper = $('<div class="mobile-slider-wrapper" />');
        mobileSliderWrapper.append(mobileSlider);
        dataElem.parent().append(mobileSliderWrapper);

        // placeholder to control width and height of slider
        //desktopSlider.append('<img class="placeholder" src="//placehold.it/' + settings.width + 'x' + settings.height + '/000000/000000.png" />');
        //mobileSlider.append('<img class="placeholder" src="//placehold.it/' + settings.width + 'x' + settings.height + '/FFFFFF/FFFFFF.png" />');
        desktopSlider.append('<img class="placeholder" src="' + settings.placeholderPath + '"/>');
        mobileSlider.append('<img class="placeholder" src="' + settings.placeholderPath + '"/>');

        // copy elements for desktop
        var desktopUlOne = $('<ul class="images" />');
        desktopUlOne.click(function(e){
            e.stopPropagation();
            e.preventDefault();
            //alert(clickThrough);
            window.location = clickThrough;
        });
        desktopSlider.append(desktopUlOne);
        var desktopUlTwoWrapperWrapper = $('<div class="captions-wrapper-wrapper" />');
        var desktopUlTwoWrapper = $('<div class="captions-wrapper" />');
        var desktopUlTwo = $('<ul class="captions" />');
        desktopUlTwoWrapper.append(desktopUlTwo);
        desktopUlTwoWrapperWrapper.append(desktopUlTwoWrapper);
        desktopSlider.append(desktopUlTwoWrapperWrapper);
        dataElem.find('li').each(function () {
            var liElemOne = $('<li />');
            $( this ).find('.img-link').clone().appendTo(liElemOne);
            liElemOne.appendTo(desktopUlOne);
            liElemOne.attr('class', $( this ).attr('class'));
            var liElemTwo = $('<li />');
            liElemTwo.css('width', (100 / nSlides) + '%' );
            $( this ).find('.desc-link').clone().appendTo(liElemTwo);
            liElemTwo.appendTo(desktopUlTwo);
            liElemTwo.attr('class', $( this ).attr('class'));
        });

        // copy elements for mobile
        var mobileUl = $('<ul class="slides" />');
        mobileUl.css('width', (100 * nSlides) + '%' );
        mobileSlider.append(mobileUl);
        var mobileUlTwoWrapperWrapper = $('<div class="captions-wrapper-wrapper" />');
        var mobileUlTwoWrapper = $('<div class="captions-wrapper" />');
        var mobileUlTwo = $('<ul class="captions" />');
        mobileUlTwoWrapper.append(mobileUlTwo);
        mobileUlTwoWrapperWrapper.append(mobileUlTwoWrapper);
        mobileSlider.append(mobileUlTwoWrapperWrapper);
        var $i = 1;
        dataElem.find('li').each(function () {
            var liElem = $('<li />');
            liElem.attr('id', 'slide' + $i);
            liElem.css('width', (100 / nSlides) + '%' );
            $( this ).find('.img-link').clone().appendTo(liElem);
            var pWrapper = $('<div class="p-wrapper" />');
            $( this ).find('.desc-link').clone().appendTo(pWrapper);
            pWrapper.appendTo(liElem);
            liElem.appendTo(mobileUl);
            var liElemTwo = $('<li />');
            liElemTwo.appendTo(mobileUlTwo);
            liElem.attr('class', $( this ).attr('class'));
            $i++;
        });

        // setActive for desktop
        function setActive(index) {
            desktopUlOne.find('li').removeClass('active');
            desktopUlOne.find('li:eq(' + index + ')').addClass('active');
            desktopUlTwo.find('li').removeClass('active');
            desktopUlTwo.find('li:eq(' + index + ')').addClass('active');
            clickThrough = desktopUlOne.find('li:eq(' + index + ')').find('a').attr("href");

            mobileUl.find('li').removeClass('active');
            mobileUl.find('li:eq(' + index + ')').addClass('active');
            mobileUlTwo.find('li').removeClass('active');
            mobileUlTwo.find('li:eq(' + index + ')').addClass('active');
            
            desktopUlTwo.find('li').find('a').click(function (e) {
                //e.preventDefault();
            });

        }
        // set first one active
        setActive(currentSlide);
        dataElem.parents('.home-slideshow-wrapper').css({"visibility":"visible"});

        // autoplay for desktop

        var apId = 0;
        var wId = 0;

        function autoSlide() {
            currentSlide++;
            if (currentSlide >= nSlides) {
                currentSlide = 0;
            }
            setActive(currentSlide);
        }

        if (settings.autoPlay) {
            apId = setInterval(autoSlide, settings.delay);
        }

        // mousover captions to control currentslide
        desktopUlTwo.find('li').each(function (index) {
            var targetIndex = index;
            $( this ).mouseover(function (e) {
                if (settings.autoPlay) {
                    clearInterval(apId);
                    clearTimeout(wId);
                    wId = setTimeout(function () {
                        apId = setInterval(autoSlide, settings.delay);
                    }, settings.wait);
                }
                currentSlide = targetIndex;
                setActive(currentSlide);
            });
        });

        
    

        // swipe on mobile
        var leftOffset = 0;
        var animate = true;
        var xDown = 0;
        var leftOffsetRef = 0;
        var leftOffsetHome = 0;
        var currentMobileSlide = 0;

        var mouseIsDown = false;
        var mouseMoved = false;

        if (Modernizr.touch) {
            mobileUl.on("touchstart", function(ev) {
                if (!mouseIsDown) {    
                    var e = ev.originalEvent;
                    //console.log(e.touches);
                    animate = false;
                    xDown = e.touches[0].clientX;
                    leftOffsetRef = leftOffset;
                    mouseIsDown = true;
                }
            });

            mobileUl.on("touchend", function(ev) {
                var e = ev.originalEvent;
                //console.log(e.touches);
                if (leftOffset > (leftOffsetRef + 120)) {
                    //console.log('swiperight');
                    currentMobileSlide--;
                    if (currentMobileSlide < 0) {
                        currentMobileSlide = 0;
                    }
                    leftOffsetHome = -currentMobileSlide * mobileSlider.find('.placeholder').width();
                } else if (leftOffset < (leftOffsetRef - 120)) {
                    //console.log('swipeleft');
                    currentMobileSlide++;
                    if (currentMobileSlide >= nSlides) {
                        currentMobileSlide = nSlides - 1;
                    }
                    leftOffsetHome = -currentMobileSlide * mobileSlider.find('.placeholder').width();
                }
                animate = true;
                mouseIsDown = false;
            });

            mobileUl.on("touchmove", function(ev) {
                if (mouseIsDown) { 
                    var e = ev.originalEvent;
                    e.preventDefault();
                    //console.log(e.touches);
                    var diff = e.touches[0].clientX - xDown;
                    leftOffset = leftOffsetRef + diff;
                    mobileUl.css('left', leftOffset + 'px');
                }
            });

        } else {

            mobileUl.on("mousedown", function(ev) {
                if (!mouseIsDown) {
                    var e = ev.originalEvent;
                    animate = false;
                    xDown = e.clientX;
                    leftOffsetRef = leftOffset;
                    mouseIsDown = true;
                    mouseMoved = false;
                }
            });

            mobileUl.on("mouseup", function(ev) {
                var e = ev.originalEvent;
                if (leftOffset > (leftOffsetRef + 120)) {
                    currentMobileSlide--;
                    if (currentMobileSlide < 0) {
                        currentMobileSlide = 0;
                    }
                    leftOffsetHome = -currentMobileSlide * mobileSlider.find('.placeholder').width();
                } else if (leftOffset < (leftOffsetRef - 120)) {
                    currentMobileSlide++;
                    if (currentMobileSlide >= nSlides) {
                        currentMobileSlide = nSlides - 1;
                    }
                    leftOffsetHome = -currentMobileSlide * mobileSlider.find('.placeholder').width();
                }
                animate = true;
                mouseIsDown = false;
            });

            mobileUl.on("mousemove", function(ev) {
                if (mouseIsDown) { 
                    var e = ev.originalEvent;
                    e.preventDefault();
                    var diff = e.clientX - xDown;
                    leftOffset = leftOffsetRef + diff;
                    mobileUl.css('left', leftOffset + 'px');
                    mouseMoved = true;
                }
            });

            mobileUl.find('a').on('dragstart', function(e) { e.preventDefault(); });

            mobileUl.find('a').click(function(e){
               if (mouseMoved) {
                   e.preventDefault();
               }
            });

            // click bullets to control currentslide for mobile
            mobileUlTwo.find('li').each(function (index) {
                var targetIndex = index;

                $( this ).click(function (ev) {
                    mobileUl.find('li').css('opacity','1');
                    currentSlide = targetIndex;
                    setActive(currentSlide);
                    var e = ev.originalEvent;
                    e.preventDefault();
                    leftOffsetHome = -targetIndex * mobileSlider.find('.placeholder').width();
                    mobileUl.css('left', leftOffsetHome + 'px');
                });
            });

            
        }

        if (!window.requestAnimationFrame) {
            window.requestAnimationFrame = (window.webkitRequestAnimationFrame ||
                                          window.mozRequestAnimationFrame ||
                                          window.msRequestAnimationFrame ||
                                          window.oRequestAnimationFrame ||
                                          function (callback) {
                                            return window.setTimeout(callback, 17);
                                          });
        }

        (function onF (){
            window.requestAnimationFrame(onF, mobileUl.get());
            if (animate) {
                leftOffset += (leftOffsetHome - leftOffset) / 8;
                mobileUl.css('left', leftOffset + 'px');
            }
        }());

        $(window).bind('resizeEnd', function() {
            mobileUl.find('li').css('opacity','1'); 
            mobileUl.css('left','0');
        });

        $(window).resize(function() {
            mobileUl.find('li').css('opacity','1'); 
            if(this.resizeTO) clearTimeout(this.resizeTO);
            this.resizeTO = setTimeout(function() {
                $(this).trigger('resizeEnd');
            }, 500);
        });

    });

  };

});